
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>VanDevSam</title>
  <meta name="author" content="Wesam Al-Haddad">

  
  <meta name="description" content="I have adopted a design philosophy for building Rails applications that seeks to
build Rails components using Plain Old Ruby Objects (POROs) [1] &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://alwesam.github.io/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="VanDevSam" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">VanDevSam</a></h1>
  
    <h2>Notes on Software</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="alwesam.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/04/24/moving-validations-away-from-models/">Moving Validations Away From Models</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-04-24T15:27:35-07:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>24</span><span class='date-suffix'>th</span>, <span class='date-year'>2018</span></span> <span class='time'>3:27 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I have adopted a design philosophy for building Rails applications that seeks to
build Rails components using Plain Old Ruby Objects (POROs) [1] guided by the
Single Responsibility Principle (SRP).  This move entails the following (among
many other things):</p>

<ul>
<li>Extracting queries from models and moving them to app/queries/</li>
<li>Extracting validations from models and moving them app/forms/</li>
</ul>


<p>However, not all validations should be (or can be) extracted from models.  In
Rails, there are two types of validations:  ActiveModel::Validations and
ActiveRecord::Validations.  The former checks the validity of the submitted
fields themselves such as presence, format, etc, while the latter checks the
validity in relation with other existing records to maintain database integrity
such as foreign keys, uniqueness. ActiveModel validations can be extracted
ActiveRecord models.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class CustomModelValidations 
</span><span class='line'>  include ActiveModel::Validations
</span><span class='line'>
</span><span class='line'>  attr_accessor :name
</span><span class='line'>  validates :name, presence: true
</span><span class='line'>
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>However, in certain cases, it might be necessary to perform integrity checks on
the submitted form prior to saving it.  Let&rsquo;s say a submission request involves
processing the form data through a background job before it&rsquo;s saved in the
database.  It would be useful to verify database integrity before launching the
background process.  In this case, we can employ a custom validation that would
involve querying the table in question</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class ModelForm
</span><span class='line'>  include ActiveModel::Validations
</span><span class='line'>
</span><span class='line'>  attr_accessor :name
</span><span class='line'>  validates :name, presence: true
</span><span class='line'>  validate  :uniqueness_of_name
</span><span class='line'>
</span><span class='line'>  private
</span><span class='line'>
</span><span class='line'>  def uniqueness_of_name
</span><span class='line'>    if Model.exists(name: self.name)
</span><span class='line'>      errors.add(:base, "Name must be unique")
</span><span class='line'>    end
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>end
</span></code></pre></td></tr></table></div></figure>


<h4>References:</h4>

<p>[1] <a href="https://www.toptal.com/ruby-on-rails/decoupling-rails-components">https://www.toptal.com/ruby-on-rails/decoupling-rails-components</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/03/21/reseting-database-and-seeding-it-from-backup-data/">Reseting Database and Seeding It From Backup Data</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-03-21T17:33:45-07:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>21</span><span class='date-suffix'>st</span>, <span class='date-year'>2018</span></span> <span class='time'>5:33 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><i>NOTE:  This script doesn&rsquo;t work when introducing structural changes to the
database such as dropping tables/columns or adding foreign key restriction to a
newly added table.</i></p>

<p>Often and early in development I resort to resetting the database and rebuilding
the schema as opposed to performing database migration.  The reason being I want
to keep a single migration file prior to initial push to production. In early
development (prior to production), a project is in constant flux and its
requirements is frequently changing.  Imagine how many migration files I have to
put up with before even pushing to production!  That&rsquo;s why I decided to keep a
single migration file (that is the initial schema) until we push to production
(or until database stabilizes).</p>

<p>However, I&rsquo;d like to keep the data (or some of it at least) populated in the
development database.  As we all know, resetting the database means destroying it
and recreating it again before seeding it from a seed file.</p>

<p>This <a href="https://github.com/rroblak/seed_dump">gem</a> allows to create a seed file
from the existing data in your database.  However, the order of seeding the
tables in the output seed file(s) doesn&rsquo;t follow foreign key restrictions (for
example populating an accounts table before users) resulting in error and
incomplete repopulation.</p>

<p>The patch I applied to work around this issue is to create a script with a loop
that goes over data repopulation in each table.  A flag is set to true if the
table is populated, otherwise move on to populate the next table until all
tables are populated. The seed file is formatted using a script in that each
<i>create!</i> is wrapped in a module (e.g LoadBData) and each create method
call is wrapped in a def method that are instances of the module.</p>

<p>From:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#data_backup.rb
</span><span class='line'>
</span><span class='line'>Account.create!([....])
</span><span class='line'>
</span><span class='line'>#...
</span><span class='line'>
</span><span class='line'>User.create!([....])
</span></code></pre></td></tr></table></div></figure>


<p>to:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#data_backup.rb
</span><span class='line'>
</span><span class='line'>module LoadBData
</span><span class='line'>
</span><span class='line'>  def create_account_records
</span><span class='line'>    Account.create!([....])
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>  #...
</span><span class='line'>
</span><span class='line'>  def create_user_records
</span><span class='line'>    User.create!([....])
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>end
</span></code></pre></td></tr></table></div></figure>


<p>And now the script to populate the database from the formatted seed file</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  class LoadBackupData
</span><span class='line'>  
</span><span class='line'>    file = Rails.root.join('db','seeds','data_backup.rb')
</span><span class='line'>    if File.exists?(file)
</span><span class='line'>      load "#{file}"
</span><span class='line'>      include LoadBData
</span><span class='line'>    end
</span><span class='line'>  
</span><span class='line'>    def initialize
</span><span class='line'>      @safety_counter = 0
</span><span class='line'>      @methods_arr    = LoadBData.instance_methods
</span><span class='line'>      @done_hash      = @methods_arr.map{|meth| [meth, false]}.inject({}) {|r,i| r[i.first] = i.last; r }
</span><span class='line'>    end
</span><span class='line'>  
</span><span class='line'>    def populate
</span><span class='line'>      loop do
</span><span class='line'>        @methods_arr.each do |meth|
</span><span class='line'>          next if @done_hash[meth]
</span><span class='line'>          begin
</span><span class='line'>            self.send(meth)
</span><span class='line'>            @done_hash[meth] = true
</span><span class='line'>          rescue =&gt; error
</span><span class='line'>            @safety_counter += 1
</span><span class='line'>          end
</span><span class='line'>        end 
</span><span class='line'>        break if (@done_hash.values.uniq.count == 1 && @done_hash.values.first == true) || @safety_counter == 100
</span><span class='line'>      end
</span><span class='line'>      puts "DONE...."
</span><span class='line'>    end
</span><span class='line'>  
</span><span class='line'>  end
</span></code></pre></td></tr></table></div></figure>


<p>NOTE: This script doesn&rsquo;t work when introducing structural changes to the
database such as dropping tables/columns or adding foreign key restriction to a
newly added table.</p>

<p>This approach works with small to medium databases though I suspect a more
intelligent approach could be followed by determining the relationships between
tables and arranging the seed file accordingly.</p>

<p>In any case complexity could
move towards creating the seed files themselves in such a manner that ensures
the tables are populated in the right order or applying a patch afterwards as I
have done here.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/02/26/webpacker-and-react-on-rails/">Integrating React Components in Rails Using Webpacker and React on Rails</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-02-26T15:56:06-08:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>26</span><span class='date-suffix'>th</span>, <span class='date-year'>2018</span></span> <span class='time'>3:56 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I like Ruby and enjoy developing and deploying web applications using Rails.
Yet, I haven&rsquo;t been a big fan of using Rails view templates or Rails many gems
to code the client.  ERB (or even slim) files tend to get messy though some
developers have evolved techniques and practices to write cleaner/simpler
html/frontend code.  On the other hand, I&rsquo;m all for using JavaScript and the
node ecosystem for any frontend solution. The two components (frontend and
backend) are separated, developed respectively and are communicating through
APIs.</p>

<p>With the advent of Webpack, it has became much easier to integrate JavaScript
components into Rails without having to go through the Rails assets pipeline [1].
Indeed, one can think of the client side as (almost) completely separate module
from the server side while not having to deploy the client on a separate node
server.</p>

<h2>Webpacker</h2>

<!-- 
### What version of Rails work for?  What version of Webpack?
Ruby 2.2+
Rails 4.2+
Node.js 6.0.0+
Yarn 0.25.2+
webpack 3.x.x
ES6 with babel -->


<p>The Webpacker <a href="https://github.com/rails/webpacker">gem</a> developed by the Rails
is enabling the integration of Webpack into Rails without altering the basic
structure of the Rails app.  It features wepback version 3.x.x and ES6 and it
uses Yarn for building. Let&rsquo;s see how Webpacker achieves that:</p>

<h3>Directory Structure</h3>

<p>Upon installing the Webpacker gem, the following main items are added to your
app:</p>

<ul>
<li>bin

<ul>
<li><strong> webpack </strong></li>
<li><strong> webpack-dev-server </strong></li>
</ul>
</li>
<li>config

<ul>
<li><strong>webpacker.yml</strong></li>
<li><strong> webpack/ </strong>

<ul>
<li>environment.js</li>
<li>development.js</li>
<li>production.js</li>
<li>test.js</li>
</ul>
</li>
</ul>
</li>
<li>app

<ul>
<li><strong> javascript/packs </strong></li>
</ul>
</li>
<li><strong> package.json </strong></li>
</ul>


<p>The main thing to look for here is that client code goes under
<i>app/javascript</i>.  That could include images, css (the folder&rsquo;s name is a
misnomer).</p>

<p>The package.json file for those who are not familiar with Node is similar to
Ruby&rsquo;s Gemfile in that it specifies the client dependencies. By default, webpack
is added to the package.json file.  The dependencies are installed in the Rails
app root directory under <i>node_modules</i> folder.</p>

<p>Lastly, webpack&rsquo;s configuration files are added under the <i>config/</i> folder
including a YAML file (discussed in the next section) as well as a
<i>webpack/</i> configuration folder (akin to the config/environments folder).
If you open a webpack config file, there is not much to see.  That&rsquo;s because,
Webpacker has taken care of it by loading a default configuration.  A custom
configuration can be added nonetheless.</p>

<h3>Config/webpacker.yml</h3>

<p>A YAML file that includes basic webpack configurations such as public output
path (under public/ folder), entry folder (default is app/javascript), and
development server parameters (host, port, etc).  The file is loaded by
Webpacker webpack config files.</p>

<h3>Rails view helper method</h3>

<p>Webpacker introduces a new Rails helper method <i>javascript_pack_tag</i>, which
loads the rails view layout template with the webpack bundled output.  It&rsquo;s
basically a wrapper of <i>javascript_include_tag</i>, in addition to the
following:</p>

<ul>
<li>It checks the public output path for the presence of bundled JavaScript output file.
If it&rsquo;s not found, a yarn build command is launched to build the client code and
generate the output file.</li>
<li>It then leverages <i>javasript_include_tag</i> to insert a <i>script</i> tag
in the html header.</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>app/views/layouts/application.html.erb
</span><span class='line'>
</span><span class='line'>&lt;html&gt;
</span><span class='line'> &lt;head&gt;
</span><span class='line'>   ---
</span><span class='line'>   &lt;%= javascript_pack_tag 'application', 'data-turbolinks-track': 'reload' %&gt;
</span><span class='line'>   &lt;%= stylesheet_pack_tag 'application', 'data-turbolinks-track': 'reload' %&gt;
</span><span class='line'>   ---
</span><span class='line'> &lt;head&gt;
</span><span class='line'> ---
</span><span class='line'>&lt;html&gt;
</span></code></pre></td></tr></table></div></figure>


<h3>JavaScript Frameworks</h3>

<p>Webpacker provides examples for integrating several JavaScript Frameworks such
as React, Elm, Vue, and Angular.</p>

<!--
More detailed:
-https://webpack.github.io/docs/webpack-dev-server.html#hot-module-replacement
-https://webpack.github.io/docs/tutorials/getting-started/#watch-mode
-https://stackoverflow.com/questions/42294827/webpack-vs-webpack-dev-server-vs-webpack-dev-middleware-vs-webpack-hot-middlewar/42354413
-https://medium.com/@rajaraodv/webpack-the-confusing-parts-58712f8fcad9

##React-Rails
-->


<h2>React_on_Rails</h2>

<p>React_on_Rails is a gem that helps with integrating React components in Rails.
It is based on Webpacker. It provides helper methods and functions on top.</p>

<!--
React on Rails is pushed for the following reasons
- support for server rendering (not used)
- passing of props from rails view to react (not used)

- redux and router integration support (not used)
- localization support (not needed)
- rspec test cases (not used)
-->


<h3>React Component Rendering</h3>

<p>React_on_rails mounts react components from Rails in the view template using
<i>react_component</i> helper method.  This method takes in the component name
as an argument in addition to a hash of options (props, id, prerender). It&rsquo;s
similar to <i>ReactDOM.render</i> method on the client side and it generates a
div component in the html page that is being served.</p>

<!--

react_component calls internal react_component which creates the JavaScript and
HMTL to allow rendering the component
inside internal_react_component create script tag application/json which embeds
the data props
Also calls server_rendered_react_component_html if prerender (else returns "")
then call build_react_component_result_for_server_rendered_string

 result = compose_react_component_html_with_spec_and_console(
      component_specification_tag, rendered_output, result_console_script
    )

 prepend_render_rails_context(result)

 Which calls compose_react_component_html_with_spec_and_console and returns this
 stuff:
   <<-HTML.html_safe
    #{component_specification_tag}
    #{rendered_output}
    #{console_script}
    HTML


  This is basically the server rendered JS component which is executed by ExecJS
  or NodeJS compile (mini_racer).  Assuming all react components and no
  redirect, it basically calls react-dom/server renderToString() function
  https://reactjs.org/docs/react-dom-server.html

  (function() {
  var railsContext = #{rails_context(server_side: true).to_json};
  #{initialize_redux_stores}
    var props = #{props_string(props).gsub("\u2028", '\u2028').gsub("\u2029", '\u2029')};
    return ReactOnRails.serverRenderReactComponent({
      name: '#{react_component_name}',
      domNodeId: '#{dom_id}',
      props: props,
      trace: #{trace},
      railsContext: railsContext
    });
  })()


  REMEMBER
  What’s the difference between client side rendering and server side rendering?
  Client side rendering — Normally when using React, your browser will download
  a minimal HTML page, and the content will be filled in by JavaScript.

  With Server side rendering, the initial content is generated on the server, so
  your browser can download a page with HTML content already in place. Updates to
  the content are still handled in the browser.

-->




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> //app/views/react_components/index.html.erb
</span><span class='line'> 
</span><span class='line'> &lt;%= react_component("ReactComponent_1", props: @react_props) %&gt;
</span></code></pre></td></tr></table></div></figure>


<p>Any react component mounted from rails view has to be registered on the client
side as follows:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'> import ReactComponent_1 from '../bundles/ReactComponent/components/ReactComponent_1';
</span><span class='line'> import ReactComponent_2 from '../bundles/ReactComponent/components/ReactComponent_2';
</span><span class='line'> 
</span><span class='line'> ReactOnRails.register({
</span><span class='line'>   ReactComponent_1,
</span><span class='line'>   ReactComponent_2
</span><span class='line'> });
</span></code></pre></td></tr></table></div></figure>


<h4>Server rendering</h4>

<p>One of the main features of the <i>react_on_rails</i> gem is that makes it
easier to enable server rendering [2].  With the <i>react_component</i> helper
method we can pass the prerender option and set it to true. Under the hood, the
helper method access the JavaScript environment (through ExecJS) to call the
ReactDOM&rsquo;s <i>renderToString</i> method, which takes the component and turn it into a
string to be embedded in the HTML.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> index.html.erb
</span><span class='line'> 
</span><span class='line'> &lt;%= react_component("ReactComponent_1", props: @react_props, prerender: true) %&gt;
</span></code></pre></td></tr></table></div></figure>




<!-- 
client rendering vs server rendering
https://medium.com/@adamzerner/client-side-rendering-vs-server-side-rendering-a32d2cf3bfcc

To get the best of both worlds

1- Use server rendering to get the first page
2- Use client rendering for subsequent requests

-->


<h3>React_on_Rails JavaScript helper functions</h3>

<!--helper functions (Authenticityhelper, WebpackConfigLoader)
The only RoR I'm using is the JavaScript API authenticityhelpers for API calls
-->


<p>React_on_Rails provides few JavaScript helper functions. I&rsquo;ll discuss two of
them here:</p>

<h4>Authenticity Helper function</h4>

<p>React_on_Rails <i>authenticityToken</i> function grabs the csrf-token from the
html page and can be appended to a header in an API call from a react component
to the server side. This ensures a verified API (POST/PUT/DELETE) request
coming from the client.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  authenticityToken() {
</span><span class='line'>    const token: ?HTMLElement = document.querySelector('meta[name="csrf-token"]');
</span><span class='line'>    if (token && (token instanceof window.HTMLMetaElement)) {
</span><span class='line'>      return token.content;
</span><span class='line'>    }
</span><span class='line'>    return null;
</span><span class='line'>  },
</span><span class='line'>
</span><span class='line'>  authenticityHeaders(otherHeaders: {[id:string]: string} = {}) {
</span><span class='line'>    return Object.assign(otherHeaders, {
</span><span class='line'>      'X-CSRF-Token': this.authenticityToken(),
</span><span class='line'>      'X-Requested-With': 'XMLHttpRequest',
</span><span class='line'>    });
</span><span class='line'>  }
</span></code></pre></td></tr></table></div></figure>


<h4>WebpackConfigLoader</h4>

<p>If you&rsquo;re not going to use Webpacker&rsquo;s default configurations (provided under
config/webpack/) and opted to write your own webpack config file, you might find
it useful to use React_on_Rails webpackConfigLoader function to load
config/webpacker.yml YAML file.  This is especially important if you&rsquo;re going to
use Webpacker&rsquo;s binstubs to build the client code (since Webpacker will access
the same config/webpacker.yml file to determine the public output path and other
related configs)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>const webpackConfigLoader = require('react-on-rails/webpackConfigLoader');
</span><span class='line'>const configPath          = resolve('..','config'); //path to config/webpacker.yml
</span><span class='line'>const { output }          = webpackConfigLoader(configPath);
</span><span class='line'>
</span><span class='line'>module.exports =
</span><span class='line'>  output: {
</span><span class='line'>    publicPath: output.publicPath,
</span><span class='line'>    path:       output.path
</span><span class='line'>  }
</span></code></pre></td></tr></table></div></figure>




<!--
Missing files from client (organization)
Move config/webpack/*.rb to client/.
Add yarn integrity check to config/envs files

Conventional webpack way vs rails/webpack way
config/webpack
cannot have my node modules in a separate folder called client 
in this case I have to have my own custom webpacker

If RoR example is not using rails/webpacker convention for webpack config how
does RoR depends on webpacker (javascript_tag_pack?)

RoR loads values from webpacker.yml file in react_on_rails/webpackConfigLoader.js
but what else?
Does it use rails/webpacker other than the above and javascript_pack_tag

Hot-reloading problem.. Still working on it
--see what's about react-intl
-->


<h3>A Custom Solution</h3>

<p>In our implmentation, we&rsquo;re just using webpacker for the following:</p>

<ul>
<li>Generate config/webpacker.yml file. The YAML file is accessed by the client
and server to determine basic configurations such as public output path.</li>
<li>javascript_pack_tag ruby helper method to load the webpack-compiled bundled
file from Rails view.</li>
</ul>


<p>In our case, all client related code (and assets) are hosted under the
<i>client/</i> directory as opposed to the app/javascript directory. Custom
webpack configuration files are used and hosted under the <i>client/</i>
directory.  In fact, the creators of React_on_Rails have emphasized this point
of separating client code and assets in a separate
<a href="https://github.com/rails/webpacker/issues/130">directory</a>.</p>

<!--
* runs yarn integrity check to ensure packages are up to date
(config.webpacker.check_yarn_integrity) -- not used (can use directly `yarn check --integrity`)
The javascript_pack_tag method is what triggers webpack to compile (when loading
the page) and then serves the bundle js to the client
-->


<p>We&rsquo;re using React on Rails for the following:</p>

<ul>
<li>JavaScript helper function ReactonRails.AuthenticityHeaders() though a local
implemenation is already being used</li>
<li>React on Rails WebpackConfigLoader function to load settings from
Webpacker&rsquo;s webpacker.yml. Again this feature can be developed locally.</li>
<li>ReactOnRails::TestHelper configuration in RSpec to build client using webpack when running RSpec tests.</li>
</ul>


<!--
### TODO list

* Web-dev-server debug
 * stylesheets generation (explore solving with styelsheet_pack_tag method)

* Explore startup registration
* Explore react_component and client registration
* Explore server rendering and execJS

* Deep-dive into chrome console for speed caching and what not
* Deep-dive into webpack itself

##web-dev-server debugging
HMR Ignored an update to unaccepted module
HMR The following modules couldn't be hot updated: (They would need a full reload!)
HMR ./screens/dashboard/LeaseManagement.jsx

##additional notes
roomia_rails->rails assets:precompile
cd client && yarn run build:production
yarn run v1.0.1
$ rm -rf ../public/webpack && NODE_ENV=production DOMAIN=roomia.com PORT=80 webpack -p --config webpack.build.config.js
Webpack production build for Rails
Hash: 6e88dbe8e66c50063089
Version: webpack 3.8.1
Time: 34211ms

Notes about speed (webpack vs sprockets)
Also, what's the initial loading time (b/c it's client heavy)

techniques to improve loading time by customizeing webpack config
https://hackernoon.com/optimising-your-application-bundle-size-with-webpack-e85b00bab579

Webpack, we're using version 3
https://medium.com/webpack/webpack-3-official-release-15fd2dd8f07b

look at network tab for loading time measurements

-->


<h2>References</h2>

<p>[1] <a href="https://medium.com/@chrismnicola/leaving-sprockets-for-webpack-ccf7c6993ffa">https://medium.com/@chrismnicola/leaving-sprockets-for-webpack-ccf7c6993ffa</a></p>

<p>[2] <a href="https://medium.com/styled-components/the-simple-guide-to-server-side-rendering-react-with-styled-components-d31c6b2b8fbf">https://medium.com/styled-components/the-simple-guide-to-server-side-rendering-react-with-styled-components-d31c6b2b8fbf</a></p>

<!--
[3] https://apidock.com/rails/ActionView/Helpers/AssetTagHelper/javascript_include_tag 
[4] https://apidock.com/rails/ActionView/Helpers/AssetTagHelper/stylesheet_link_tag
-->

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/11/07/running-multiple-background-jobs-and-accessing-i-slash-o/">Running Multiple Background Jobs and Accessing I/O</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-11-07T11:38:00-08:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>7</span><span class='date-suffix'>th</span>, <span class='date-year'>2017</span></span> <span class='time'>11:38 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>(Updated January 30, 2018)</p>

<p>One of the features of the application I have been working on is to
automatically transfer funds via EFT between users.  The payment process of
initiating debit/credit transactions involves uploading a file of transactions
through batch payment API to the payment gateway.  Each line in the file
constitute a transaction.</p>

<p>Since there is a cap on the total dollar amount in each file upload, multiple
batches are to be uploaded.  The issue we have to face is that the payment
gateway server cannot handle multiple API requests in rapid succession. Assuming
a batch limit of $50,000 and a total amount of $20 million that needs to be
processed, that is about 400 batches or API requests!</p>

<h3>Enter Background Job</h3>

<p>It&rsquo;s a good practice to processes API requests (especially those that involve
payments) through separate background jobs.  The advantages are as follows:</p>

<ul>
<li>Intensive I/O tasks such as uploading files will be handled separately
in a worker process.</li>
<li>Multiple jobs can be run on separate threads concurrently.  While Ruby doesn&rsquo;t
support CPU multithreading (due to GIL), I/O tasks (such as processing
API requests or writing to disk) can be processed simultaneously.</li>
<li>Background jobs can be retried several times until they are successfully
completed.  The downside part is that we have to ensure that each job is
idempotent (explained later in the post).</li>
</ul>


<p>When batches are created, each is put through a background job in
order to complete an API request. Each job takes in an array of transactions
and creates a file on the fly (which is written to a tmp/ directory); the file
is immediately uploaded through the API request.</p>

<h4>A background job is its own world</h4>

<p>Each job constitutes its own thread with its own data and arguments such that it
can be retried without having to relay on new information.  In the above
example, the main data is an array of transaction objects that include amount,
customer code, and whether it&rsquo;s debit or credit.</p>

<p>Yet, all job threads access the same I/O. More likely than not, unless the
jobs' execution is throttled, subsequent jobs will fail to complete as the API
server is busy.  Suppose that we want to throttle the API requests at 1
request/minute; that means 200 minutes is required to upload all batches.  We
might do better if we do not manually throttle the API requests and instead use
the retrial feature to our advantage where let jobs fail and retried at a rate
determined by the background job processor (see below).</p>

<p>Furthermore, each job is accessing the tmp/ directory to write/upload the batch
file. To prevent cross-contamination/overwriting, files are uniquely named
along with a datetime stamp.</p>

<p>  <em>Writing to tmp/ is very quick. Writing 400 batch files of 25 lines each in
rapid loop takes less than 170ms. Writing a single file much less than 1ms.
It&rsquo;s during the upload that the file risks being overwritten or contaminated if
it&rsquo;s not uniquely identified with a unique identifier</em>.</p>

<p>Another option is to have the batch files created before and sending the files'
paths as data to the background jobs. The main advantage of this approach is
to minimize the risk of cross-contamination of multiple job threads while
accessing the tmp/ directory as well as not having to regenerate the file every
time the job fails. The disadvantage, however, is that the job doesn&rsquo;t include
the transactions data and it has to relay on the tmp directory keeping the file
saved while retrying the job several times after failure.</p>

<h4>Error Handling, Job Completion, and Retries</h4>

<p>To ensure completion, Sidekiq retries failed job up to 25 times after which a
job is moved to dead jobs queue. An error can be raised by a bug in the code or in the
example mentioned above an API error. Also, an exception can be raised if the
job is not complete (batch ID is not returned) forcing a retrial.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class BatchJob
</span><span class='line'>
</span><span class='line'>  def perform *args
</span><span class='line'>     task = UploadFile.new(args).call 
</span><span class='line'>     unless task.complete?
</span><span class='line'>      raise "Job Fail"
</span><span class='line'>     end
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<h4>Idempotency</h4>

<p>Idempotency means that a job can be executed multiple times safely.  This is
especially important when it comes to financial transactions. There should not
be &ldquo;half-completed&rdquo; transactions.  Any database transaction during the job is to
be rolled back in case of job failure.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class BatchJob
</span><span class='line'>
</span><span class='line'>  def perform *args
</span><span class='line'>    #....
</span><span class='line'>    ActiveRecord::Base.transaction do
</span><span class='line'>      # DB transactions goes here
</span><span class='line'>    end
</span><span class='line'>    #...
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<h3>Sidekiq</h3>

<p><a href="https://github.com/mperham/sidekiq">Sidekiq</a> is employed to manage multiple
HTTP file uploads in the background.  It&rsquo;s noted for speed in comparison to
Delayed Job (4,500 jobs/second and a latency of 10ms). Sidekiq uses Redis for
storing and queuing jobs as opposed to using the database.
Furthermore, Sidekiq has an error-handling mechanism where it retries a failed
job with an exponential backoff.</p>

<h4>Retries</h4>

<p>By default, Sidekiq retries a job after it fails up to 25 times.  The timing of
the retry is governed by this formula:</p>

<p><em>(retry_count**4) + 15 + (rand(30) * (retry_count + 1))</em></p>

<h4>Results</h4>

<p>The code was tested by launching a task to process transactions worth
$8M.  The transactions were distributed in 160 batches ($50K per batch) and each
batch was processed through a separate Sidekiq background thread.</p>

<p>It took about 25 minutes to finish uploading all the files to the payment
gateway.  Of the 160 background jobs, 53 jobs were successfully completed from
the first attempt (i.e. no retrials were needed).  One job took 6 retries before
it was successfully completed.  The average number of retrials was 2.31.</p>

<p><img class="center" src="/images/retries.png" width="400" height="350" title="retries" alt="retries bar chart"></p>

<!--
#notes
![](../images/retries.png)
##Time interval at which jobs successfully completed
If the Sidekiq process segfaults or crashes the Ruby VM, any jobs that were
being processed are lost. Sidekiq Pro offers a reliable queueing feature which
does not lose those jobs.
#####To-do list:
* Default of 25 threads per process (concurrency in ruby is not exactly
supported)
* Sidekiq is designed for parallel execution so design your jobs so you can run
lots of them in parallel. It has basic features for tuning concurrency (e.g.
targeting a sidekiq process at a queue with a defined number of threads) but
your system architecture is much simpler if you don't have such specialization.
Set at 20 in production and 5 in development
* Automatic job retry at (retry_count ** 4)+15+(rand(30)*(retry_count+1)).  For
example, at the 6th retry will occur between 640 and 820 seconds after the 5th
retry.
* Custom middleware needed to fetch #job_id and retry_count.
* Also need to customize retry time depending on job so to make them apart based
on job id
* Limit number of pool connections for batch API upload job (go down from
default of 25 to 5 or even to 1) -->

</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2018/04/24/moving-validations-away-from-models/">Moving Validations Away From Models</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/03/21/reseting-database-and-seeding-it-from-backup-data/">Reseting Database and Seeding It From Backup Data</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/02/26/webpacker-and-react-on-rails/">Integrating React Components in Rails Using Webpacker and React on Rails</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/11/07/running-multiple-background-jobs-and-accessing-i-slash-o/">Running Multiple Background Jobs and Accessing I/O</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub</h1>
  <!--<ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul> -->
  
  <a href="https://github.com/alwesam">@alwesam</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        //github.showRepos({
        //    user: 'alwesam',
        //    count: 0,
        //    skip_forks: true,
        //    target: '#gh_repos'
        //});
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>




  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2018 - Wesam Al-Haddad -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
