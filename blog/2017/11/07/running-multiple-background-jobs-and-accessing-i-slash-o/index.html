
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Running Multiple Background Jobs and Accessing I/O - VanDevSam</title>
  <meta name="author" content="Wesam Al-Haddad">

  
  <meta name="description" content="One of the features of the application I have been working on is to
automatically transfer funds via EFT between users. The payment process of &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://alwesam.github.io/blog/2017/11/07/running-multiple-background-jobs-and-accessing-i-slash-o/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="VanDevSam" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">VanDevSam</a></h1>
  
    <h2>Notes on Software and Technology</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="alwesam.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Running Multiple Background Jobs and Accessing I/O</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-11-07T11:38:00-08:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>7</span><span class='date-suffix'>th</span>, <span class='date-year'>2017</span></span> <span class='time'>11:38 am</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>One of the features of the application I have been working on is to
automatically transfer funds via EFT between users.  The payment process of
initiating debit/credit transactions involves uploading a file of transactions
through batch payment API to the payment gateway.  Each line in the file
constitute a transaction.</p>

<p>Since there is a cap on the total dollar amount in each batch API upload,
several batches are to be uploaded and fired.  Problem is that the payment
gateway server cannot handle multiple API requests in rapid succession. Assuming
a batch limit of 50,000 and a total amount of 20 million, that is about 400
batches that need to be processed!</p>

<h3>Enter Background Job</h3>

<p>When batches are created, each is put through a background job in
order to complete an API request. Each job takes in an array of transactions
and creates a file on the fly (which is written to a tmp/ directory); the file
is subsequently uploaded through the API request.</p>

<p>Each job constitutes its own thread yet they access the same I/O. More likely
than not, unless the jobs' execution is throttled, subsequent job processing
will fail to complete as the server is busy.  Suppose that we want to throttle
the API request at 1 request/minute; that means 400 minutes or 7 hours required
to upload all batches for 20 million.  At 1 request/30 seconds, less than 4
hours is required. Yet, we might do better if we do not manually throttle the
API requests and let it the processor determine the throttle (more to discuss later).</p>

<p>Furthermore, each job is accessing the tmp/ directory to write/upload the batch
file.  To prevent cross-contamination/overwriting, files' name should include with job
id and the datetime (down to milliseconds).</p>

<p>  <em>Writing to tmp/ is very quick. Writing 400 batch files of 25 lines each in
rapid loop takes less than 170ms. Writing a single file much less than 1ms. It&rsquo;s
during the upload that the file risks being overwritten or contaminated if it&rsquo;s
not uniquely identified with a precise time stamp or (better) a unique
identifier</em>.</p>

<p>Another option is to have the batch files created before and sending the files'
path as arguments to the background jobs.  The main advantages of this approach
is to minimize the risk of cross-contamination of multiple job threads write
accessing the tmp/ directory as well as not having to regenerate the file (with
a different timestamp) every time the job fails. The disadvantage of this
approach is the job thread doesn&rsquo;t hold onto the transactions data and it
has to relay on the tmp directory keeping the file saved while retrying the job
several times after failure.</p>

<h3>Sidekiq</h3>

<p><a href="https://github.com/mperham/sidekiq">Sidekiq</a> is employed to manage multiple
HTTP file uploads in the background.  It&rsquo;s noted for speed in comparison to
Delayed Job (4,500 jobs/second and a latency of 10ms). In addition, Sidekiq uses
Redis for queuing jobs as opposed to using the database.</p>

<h5>To-do list:</h5>

<!--
* Default of 25 threads per process (concurrency in ruby is not exactly
supported)
* Sidekiq is designed for parallel execution so design your jobs so you can run
lots of them in parallel. It has basic features for tuning concurrency (e.g.
targeting a sidekiq process at a queue with a defined number of threads) but
your system architecture is much simpler if you don't have such specialization.
Set at 20 in production and 5 in development
* Automatic job retry at (retry_count ** 4)+15+(rand(30)*(retry_count+1)).  For
example, at the 6th retry will occur between 640 and 820 seconds after the 5th
retry. -->


<ul>
<li>Custom middleware needed to fetch #job_id and retry_count.</li>
<li>Also need to customize retry time depending on job so to make them apart based
on job id</li>
<li>Limit number of pool connections for batch API upload job (go down from
default of 25 to 5 or even to 1)</li>
</ul>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Wesam Al-Haddad</span></span>

      




<time class='entry-date' datetime='2017-11-07T11:38:00-08:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>7</span><span class='date-suffix'>th</span>, <span class='date-year'>2017</span></span> <span class='time'>11:38 am</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/ruby/'>ruby</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://alwesam.github.io/blog/2017/11/07/running-multiple-background-jobs-and-accessing-i-slash-o/" data-via="vandevsam" data-counturl="http://alwesam.github.io/blog/2017/11/07/running-multiple-background-jobs-and-accessing-i-slash-o/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2017/11/03/how-to-improve-performance/" title="Previous Post: How to Do Things Better">&laquo; How to Do Things Better</a>
      
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2017/11/07/running-multiple-background-jobs-and-accessing-i-slash-o/">Running Multiple Background Jobs and Accessing I/O</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/11/03/how-to-improve-performance/">How to Do Things Better</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/10/28/what-im-intending-to-write-about/">What Am I Intending to Write About on This Blog</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub</h1>
  <!--<ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul> -->
  
  <a href="https://github.com/alwesam">@alwesam</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        //github.showRepos({
        //    user: 'alwesam',
        //    count: 0,
        //    skip_forks: true,
        //    target: '#gh_repos'
        //});
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>




  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2017 - Wesam Al-Haddad -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
